<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="csrf-token" content="{{ csrf_token() }}">
<title>BharatMail - Inbox</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script>
    // Make CSRF token available globally
    window.csrfToken = "{{ csrf_token() }}";
    
    // Notification system initialization
    let notificationPermission = 'default';
    let serviceWorkerRegistration = null;
    let isNotificationsEnabled = false;
</script>

<style>
    :root { --accent: #1a73e8; }

    @media (prefers-color-scheme: dark) {
        body { background-color: #202124; color: #e8eaed; }
        .sidebar { background-color: #2d2e30; border-right: 1px solid #3c4043; }
        .email-item:hover { background-color: #3c4043; }
        .dropdown { background-color: #2d2e30; color: white; border: 1px solid #3c4043; }
        .dropdown-item:hover { background-color: #3c4043; }
        #mailSearch { background-color: #3c4043; color: white; border: 1px solid #5f6368; }
    }

    @media (prefers-color-scheme: light) {
        body { background-color: #ffffff; color: #000000; }
        .sidebar { background-color: #f1f3f4; border-right: 1px solid #dadce0; }
        .email-item:hover { background-color: #f1f3f4; }
        .dropdown { background-color: white; color: black; border: 1px solid #dadce0; }
        .dropdown-item:hover { background-color: #f1f3f4; }
        #mailSearch { background-color: white; color: black; border: 1px solid #ccc; }
    }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    .sidebar {
        width: 250px;
        display: flex;
        flex-direction: column;
        padding: 10px;
        transition: transform 0.3s ease;
        background-color: inherit;
        z-index: 300;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        transform: translateX(0);
    }

    .sidebar.hidden {
        transform: translateX(-100%);
    }

    .logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
    }

    .logo img {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        margin-right: 8px;
        object-fit: cover;
    }

    .compose-btn {
        background-color: var(--accent);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 20px;
        margin-bottom: 20px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .menu-item {
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
    }

    .menu-item:hover {
        background-color: rgba(26, 115, 232, 0.1);
    }

    .top-bar {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0 20px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        z-index: 100;
        background: inherit;
        transition: left 0.3s ease;
    }

    .profile-pic, .profile-initials {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        object-fit: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        border: 3px solid rgba(255,255,255,0.15);
        transition: all 0.3s ease;
        overflow: hidden;
        letter-spacing: 0px;
        line-height: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
    
    .profile-pic:hover, .profile-initials:hover {
        transform: scale(1.05);
        border-color: rgba(255,255,255,0.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        width: 280px;
        border-radius: 8px;
        display: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 200;
    }

    .dropdown-header {
        padding: 15px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        text-align: center;
    }

    .dropdown-header img, .dropdown-header .profile-initials {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        margin: 0 auto 12px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 700;
        color: white;
        border: 3px solid rgba(255,255,255,0.1);
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        line-height: 1;
        letter-spacing: 0.5px;
    }

    .dropdown-item {
        padding: 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
    }

    .dropdown-item .remove-btn {
        background: none;
        border: none;
        color: red;
        cursor: pointer;
        font-size: 14px;
    }

    .email-section {
        margin-top: 50px;
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-left: 250px;
        transition: margin-left 0.3s ease;
        padding: 10px;
        box-sizing: border-box;
    }
    /* Floating Compose Button */
    .compose-float-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        font-weight: bold;
        cursor: pointer;
        z-index: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Top bar utility buttons */
    .top-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--accent);
        margin-left: 10px;
    }

    @media (max-width: 768px) {
        .top-btn { display: none; }
    }

    .email-search {
        padding: 10px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
    }

    #mailSearch {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .email-list {
        flex: 1;
        overflow-y: auto;
    }

    .email-item {
        padding: 12px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        cursor: pointer;
    }

    .email-item strong {
        display: block;
    }

    /* Sidebar toggle for all screens */
    .menu-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        font-size: 22px;
        cursor: pointer;
        color: var(--accent);
        background: transparent;
        border: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .sidebar {
            /* Removed transform from here to avoid conflict */
        }
        .email-section {
            margin-left: 0;
        }
        .top-bar {
            left: 0 !important;
        }
    }

    /* Compose Panel Styles */
    .compose-panel {
        position: fixed;
        top: 50px;
        right: 0;
        width: 400px;
        height: calc(100vh - 50px);
        background-color: inherit;
        border-left: 1px solid rgba(128,128,128,0.2);
        box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        padding: 15px;
        box-sizing: border-box;
        display: none;
        flex-direction: column;
        z-index: 400;
        overflow-y: auto;
    }

    /* Mobile compose panel */
    @media (max-width: 768px) {
        .compose-panel {
            width: 100vw;
            top: 0;
            left: 0;
            height: 100vh;
            border-left: none;
            box-shadow: none;
        }
        
        .dropdown {
            width: 90vw;
            max-width: 280px;
            right: 5vw;
        }
        
        .top-bar {
            padding: 0 15px;
        }
        
        .email-section {
            padding: 5px;
        }
    }

    .compose-panel header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .compose-panel header h2 {
        margin: 0;
        font-size: 18px;
    }

    .compose-panel header button.close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--accent);
    }

    .compose-panel .compose-brand {
        text-align: center;
        font-weight: bold;
        font-size: 20px;
        margin-bottom: 10px;
        letter-spacing: 1px;
        color: var(--accent);
    }

    .compose-panel form {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .compose-panel label {
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 4px;
        font-size: 14px;
    }

    .compose-panel input[type="text"],
    .compose-panel input[type="email"],
    .compose-panel textarea {
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
        box-sizing: border-box;
        background-color: inherit;
        color: inherit;
        resize: vertical;
    }

    .compose-panel textarea {
        min-height: 120px;
    }

    .compose-panel input[type="file"] {
        margin-top: 8px;
    }

    .compose-panel button.send-btn {
        margin-top: 15px;
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
        align-self: flex-end;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .compose-panel .attachment-preview {
        margin-top: 8px;
        margin-bottom: 8px;
    }
    .compose-panel .attachment-preview div {
        display: inline-flex;
        align-items: center;
        background: rgba(26,115,232,0.08);
        border-radius: 12px;
        padding: 4px 10px;
        margin-right: 6px;
        margin-bottom: 4px;
        font-size: 13px;
    }
    .compose-panel .attachment-preview button {
        background: none;
        border: none;
        color: #e53935;
        margin-left: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }
</style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="/static/logo.png" alt="BharatMail Logo">
            BharatMail
        </div>
        <button class="compose-btn" onclick="openCompose()">
            <i class="fa-solid fa-pencil"></i> Compose
        </button>
        <div class="menu-item" onclick="filterCategory('All')" data-category="All">All Mail</div>
        <div class="menu-item" onclick="filterCategory('Inbox')" data-category="Inbox">Inbox</div>
        <div class="menu-item" onclick="filterCategory('Promotions')" data-category="Promotions">Promotions</div>
        <div class="menu-item" onclick="filterCategory('Social')" data-category="Social">Social</div>
        <div class="menu-item" onclick="filterCategory('Updates')" data-category="Updates">Updates</div>
        <div class="menu-item" onclick="filterCategory('Sent')" data-category="Sent">Sent</div>
        <div class="menu-item" onclick="filterCategory('Drafts')" data-category="Drafts">Drafts</div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="menu-toggle-btn" aria-label="Toggle Menu" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </button>
        <button class="top-btn" onclick="refreshMails()" title="Refresh"><i class="fa-solid fa-arrows-rotate"></i></button>
        <button class="top-btn" onclick="selectAllMails()" title="Select All Visible Emails"><i class="fa-solid fa-check"></i></button>
        <button class="top-btn" onclick="deselectAllMails()" title="Deselect All"><i class="fa-solid fa-xmark"></i></button>
        <div id="selectionInfo" style="display:none; margin-left: 15px; font-size: 12px; color: var(--accent); background: rgba(26,115,232,0.1); padding: 4px 8px; border-radius: 12px;">
            <span id="selectedCount">0</span> selected
        </div>
        <div style="flex:1"></div>
        {% if user_profile_pic %}
            <img src="{{ user_profile_pic }}" alt="Profile" class="profile-pic" onclick="toggleDropdown()">
        {% else %}
            {% set name_parts = user_name.split() %}
            {% if name_parts|length >= 2 %}
                {% set initials = (name_parts[0][0] ~ name_parts[-1][0])|upper %}
            {% elif name_parts|length == 1 %}
                {% set initials = name_parts[0][0:2]|upper %}
            {% else %}
                {% set initials = user_email[0]|upper %}
            {% endif %}
            <div class="profile-initials" style="background-color: {{ profile_bg_color }};" onclick="toggleDropdown()">
                {{ initials }}
            </div>
        {% endif %}
        <div class="dropdown" id="profileDropdown">
            <!-- Current Active Account -->
            <div class="dropdown-header active-account">
                {% if user_profile_pic %}
                    <img src="{{ user_profile_pic }}" alt="Profile">
                {% else %}
                    <div class="profile-initials" style="background-color: {{ profile_bg_color }};">
                        {{ initials }}
                    </div>
                {% endif %}
                <strong>{{ user_name }}</strong>
                <small>{{ user_email }}</small>
                <div class="active-indicator"><i class="fa-solid fa-check-circle"></i> Currently active</div>
            </div>

            <!-- Other Available Accounts -->
            {% if other_accounts %}
            <div class="accounts-section-header">Switch to:</div>
            {% for acc in other_accounts %}
            <div class="dropdown-item account-item">
                <span onclick="window.location.href='/switch_account/{{ acc.email }}'" style="flex:1;cursor:pointer;" title="Switch to this account">
                    <strong>{{ acc.name }}</strong><br><small>{{ acc.email }}</small>
                </span>
                <i class="fa-solid fa-right-from-bracket logout-btn" title="Remove this account" 
                   onclick="window.location.href='/logout/{{ acc.email }}'"></i>
            </div>
            {% endfor %}
            {% endif %}

            <div class="dropdown-item" onclick="window.location.href='/login?add=1'">
                <i class="fa-solid fa-plus"></i> Add account
            </div>
            <div class="dropdown-item" onclick="window.location.href='/manage_profile'">
                <i class="fa-solid fa-user-gear"></i> Manage Profile
            </div>
            <div class="dropdown-item" onclick="window.location.href='/logout'">
                <i class="fa-solid fa-right-from-bracket"></i> Logout
            </div>
        </div>
    </div>

    <!-- Compose Panel -->
    <div class="compose-panel" id="composePanel">
        <div class="compose-brand">BharatMail</div>
        <header>
            <h2>New Message</h2>
            <button class="close-btn" aria-label="Close Compose" onclick="closeCompose()">&times;</button>
        </header>
        <form id="composeForm" action="/send_mail" method="post" enctype="multipart/form-data">
            <label for="fromEmail">From</label>
            <input type="email" id="fromEmail" name="from" value="{{ user_email }}" readonly>

            <label for="toEmail">To</label>
            <input type="email" id="toEmail" name="to" placeholder="Recipient email" required>

            <div style="display: flex; gap: 10px; align-items: center; margin-bottom:4px;">
                <button type="button" onclick="toggleCC()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;padding:0;">CC</button>
                <button type="button" onclick="toggleBCC()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;padding:0;">BCC</button>
            </div>
            <div id="ccRow" style="display:none;">
                <label for="ccEmail" style="margin-top:0;">CC</label>
                <input type="email" id="ccEmail" name="cc" placeholder="CC email(s)">
            </div>
            <div id="bccRow" style="display:none;">
                <label for="bccEmail" style="margin-top:0;">BCC</label>
                <input type="email" id="bccEmail" name="bcc" placeholder="BCC email(s)">
            </div>

            <label for="subject">Subject</label>
            <input type="text" id="subject" name="subject" placeholder="Subject">

            <label for="messageBody">Message</label>
            <textarea id="messageBody" name="message" placeholder="Write your message here..."></textarea>

            <label for="attachments">Attachments</label>
            <input type="file" id="attachments" name="attachments" multiple>
            <div class="attachment-preview" id="attachmentList"></div>

            <button type="submit" class="send-btn"><i class="fa-solid fa-paper-plane"></i> Send</button>
        </form>
    </div>

    <!-- Email Section -->
    <div class="email-section">
        <!-- Mail Search -->
        <div class="email-search">
            <input type="text" id="mailSearch" placeholder="Search mails...">
        </div>

        <!-- Email List -->
        <div class="email-list" id="mailList">
            <!-- Inbox Messages -->
            {% for m in categorized_mails['Inbox'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Inbox">
                <strong>{{ m.sender }}</strong>
                <span>{{ m.subject }}</span>
            </div>
            {% endfor %}
            
            <!-- Promotions Messages -->
            {% for m in categorized_mails['Promotions'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Promotions">
                <strong>{{ m.sender }}</strong>
                <span>{{ m.subject }}</span>
            </div>
            {% endfor %}
            
            <!-- Social Messages -->
            {% for m in categorized_mails['Social'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Social">
                <strong>{{ m.sender }}</strong>
                <span>{{ m.subject }}</span>
            </div>
            {% endfor %}
            
            <!-- Updates Messages -->
            {% for m in categorized_mails['Updates'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Updates">
                <strong>{{ m.sender }}</strong>
                <span>{{ m.subject }}</span>
            </div>
            {% endfor %}
            
            <!-- Sent Messages -->
            {% for m in categorized_mails['Sent'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Sent">
                <strong>To: {{ m.receiver }}</strong>
                <span>{{ m.subject }}</span>
            </div>
            {% endfor %}
            
            <!-- Draft Messages -->
            {% for m in categorized_mails['Drafts'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Drafts">
                <strong>Draft to: {{ m.receiver or 'No recipient' }}</strong>
                <span>{{ m.subject or '(No subject)' }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

<script>
function toggleDropdown() {
    const menu = document.getElementById('profileDropdown');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

document.addEventListener('click', function(e) {
    const menu = document.getElementById('profileDropdown');
    if (!e.target.closest('.profile-pic') && !e.target.closest('.profile-initials') && !e.target.closest('.dropdown')) {
        menu.style.display = 'none';
    }
});

function removeAccount(id) {
    window.location.href = '/switch_account/' + id;
}

// Step 3: JS function to filter emails
function filterCategory(category) {
    document.querySelectorAll('.email-item').forEach(item => {
        if(category === 'All' || item.dataset.category === category) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
    updateDeleteButtonVisibility();
}

// Mail search functionality
document.getElementById('mailSearch').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll('#mailList .email-item').forEach(function(item) {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(filter) ? '' : 'none';
    });
    updateDeleteButtonVisibility();
});

// Sidebar toggle for all screens
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('hidden');
    const topBar = document.querySelector('.top-bar');
    if (sidebar.classList.contains('hidden')) {
        topBar.style.left = '0';
        document.querySelector('.email-section').style.marginLeft = '0';
    } else {
        topBar.style.left = '250px';
        document.querySelector('.email-section').style.marginLeft = '250px';
    }
}

// Initialize sidebar as visible on desktop
window.addEventListener('load', function() {
    if (window.innerWidth > 1024) {
        document.getElementById('sidebar').classList.remove('hidden');
        document.querySelector('.top-bar').style.left = '250px';
        document.querySelector('.email-section').style.marginLeft = '250px';
    } else {
        document.getElementById('sidebar').classList.add('hidden');
        document.querySelector('.top-bar').style.left = '0';
        document.querySelector('.email-section').style.marginLeft = '0';
    }
});

// Close sidebar when clicking outside on mobile
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.menu-toggle-btn');
    if (window.innerWidth <= 1024) {
        if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
            sidebar.classList.add('hidden');
            const topBar = document.querySelector('.top-bar');
            topBar.style.left = '0';
            document.querySelector('.email-section').style.marginLeft = '0';
        }
    }
});

// Compose panel control
function openCompose() {
    document.getElementById('composePanel').style.display = 'flex';
}

function closeCompose() {
    document.getElementById('composePanel').style.display = 'none';
}

// Compose attachment preview and removal
document.addEventListener('DOMContentLoaded', function() {
    var attachInput = document.getElementById('attachments');
    var attachList = document.getElementById('attachmentList');
    if (attachInput && attachList) {
        attachInput.addEventListener('change', function(){
            attachList.innerHTML = '';
            Array.from(this.files).forEach((file, index) => {
                const div = document.createElement('div');
                div.textContent = file.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.onclick = () => {
                    const dt = new DataTransfer();
                    Array.from(attachInput.files).forEach((f,i) => { if(i!==index) dt.items.add(f) });
                    attachInput.files = dt.files;
                    // re-trigger change to update
                    const event = new Event('change', {bubbles:true});
                    attachInput.dispatchEvent(event);
                };
                div.appendChild(removeBtn);
                attachList.appendChild(div);
            });
        });
    }
});

// CC/BCC toggle
function toggleCC() {
    var ccRow = document.getElementById('ccRow');
    if (ccRow) ccRow.style.display = ccRow.style.display === 'none' ? 'block' : 'none';
}
function toggleBCC() {
    var bccRow = document.getElementById('bccRow');
    if (bccRow) bccRow.style.display = bccRow.style.display === 'none' ? 'block' : 'none';
}
// Hide CC/BCC initially
document.addEventListener('DOMContentLoaded', function() {
    var ccRow = document.getElementById('ccRow');
    var bccRow = document.getElementById('bccRow');
    if(ccRow) ccRow.style.display = 'none';
    if(bccRow) bccRow.style.display = 'none';
});

// Debounce mechanism
let refreshTimeout = null;
let lastRefreshTime = 0;
const MIN_REFRESH_INTERVAL = 2000; // 2 seconds

function refreshMails() {
    const now = Date.now();
    
    // Debounce: prevent too frequent refreshes
    if (now - lastRefreshTime < MIN_REFRESH_INTERVAL) {
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
        }
        refreshTimeout = setTimeout(() => {
            performRefresh();
        }, MIN_REFRESH_INTERVAL - (now - lastRefreshTime));
        return;
    }
    
    performRefresh();
}

function performRefresh() {
    const refreshBtn = document.querySelector('button[onclick="refreshMails()"]');
    const icon = refreshBtn.querySelector('i');
    
    // Prevent multiple simultaneous refreshes
    if (refreshBtn.disabled) {
        return;
    }
    
    // Add visual feedback
    icon.style.animation = 'spin 1s linear infinite';
    refreshBtn.disabled = true;
    refreshBtn.style.opacity = '0.6';
    refreshBtn.title = 'Refreshing...';
    
    // Add CSS for spin animation if it doesn't exist
    if (!document.querySelector('#refresh-animation-style')) {
        const style = document.createElement('style');
        style.id = 'refresh-animation-style';
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Get CSRF token
    const csrfToken = getCsrfToken();
    
    // Make secure AJAX request
    fetch('/api/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            updateEmailList(data.categorized_mails);
            showRefreshSuccess(data.total_messages);
            lastRefreshTime = Date.now();
        } else {
            throw new Error('Refresh failed');
        }
    })
    .catch(error => {
        console.error('Refresh error:', error);
        showRefreshError(error.message);
        // Fallback to page reload if AJAX fails
        if (error.message.includes('CSRF') || error.message.includes('401')) {
            setTimeout(() => window.location.reload(), 1000);
        }
    })
    .finally(() => {
        // Reset button state
        icon.style.animation = '';
        refreshBtn.disabled = false;
        refreshBtn.style.opacity = '1';
        refreshBtn.title = 'Refresh';
    });
}

// Helper function to get CSRF token
function getCsrfToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    // Fallback: try to get from a hidden form field
    const hiddenField = document.querySelector('input[name="csrf_token"]');
    if (hiddenField) {
        return hiddenField.value;
    }
    
    // Last resort: try to get from template variable (if available)
    return window.csrfToken || '';
}

// Update email list with new data
function updateEmailList(categorizedMails) {
    const mailListElement = document.getElementById('mailList');
    if (!mailListElement) return;
    
    // Clear existing emails
    mailListElement.innerHTML = '';
    
    // Add emails by category
    const categories = ['Inbox', 'Promotions', 'Social', 'Updates', 'Sent', 'Drafts'];
    
    categories.forEach(category => {
        const mails = categorizedMails[category] || [];
        mails.forEach(mail => {
            const emailDiv = document.createElement('div');
            emailDiv.className = 'email-item';
            emailDiv.setAttribute('data-id', mail.id);
            emailDiv.setAttribute('data-category', category);
            
            let senderText = '';
            if (category === 'Sent') {
                senderText = `To: ${mail.receiver}`;
            } else if (category === 'Drafts') {
                senderText = `Draft to: ${mail.receiver || 'No recipient'}`;
            } else {
                senderText = mail.sender;
            }
            
            const subjectText = mail.subject || (category === 'Drafts' ? '(No subject)' : '');
            
            emailDiv.innerHTML = `
                <strong>${senderText}</strong>
                <span>${subjectText}</span>
            `;
            
            // Add event listeners
            emailDiv.addEventListener('click', handleEmailItemClick);
            emailDiv.addEventListener('touchstart', handleEmailItemLongPress);
            emailDiv.addEventListener('touchend', handleEmailItemTouchEnd);
            
            mailListElement.appendChild(emailDiv);
        });
    });
    
    // Update visibility based on current filter
    const activeFilter = document.querySelector('.menu-item.active');
    if (activeFilter) {
        const category = activeFilter.textContent.trim();
        if (category !== 'All Mail') {
            filterCategory(category);
        }
    }
    
    // Clear any existing selections
    clearSelections();
}

// Show success message
function showRefreshSuccess(totalMessages) {
    showNotification(`Refreshed successfully! Found ${totalMessages} messages.`, 'success');
}

// Show error message
function showRefreshError(errorMessage) {
    showNotification(`Refresh failed: ${errorMessage}`, 'error');
}

// Generic notification function
function showNotification(message, type = 'info') {
    // Remove existing notification
    const existing = document.querySelector('.refresh-notification');
    if (existing) {
        existing.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `refresh-notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// --- Email Selection and Delete Button Logic ---
const selectedEmailIds = new Set();
let longPressTimer = null;

function updateDeleteButtonVisibility() {
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const selectionInfo = document.getElementById('selectionInfo');
    const selectedCount = document.getElementById('selectedCount');
    
    if (!deleteBtn || !selectionInfo || !selectedCount) return;
    
    // Count visible selected emails
    let visibleSelectedCount = 0;
    document.querySelectorAll('.email-item').forEach(item => {
        if (item.style.display !== 'none' && selectedEmailIds.has(item.dataset.id)) {
            visibleSelectedCount++;
        }
    });
    
    // Show/hide delete button and selection info
    const hasSelection = visibleSelectedCount > 0;
    deleteBtn.style.display = hasSelection ? 'flex' : 'none';
    selectionInfo.style.display = hasSelection ? 'block' : 'none';
    selectedCount.textContent = visibleSelectedCount;
}

function clearSelections() {
    selectedEmailIds.clear();
    document.querySelectorAll('.email-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    updateDeleteButtonVisibility();
}

function handleEmailItemClick(e) {
    // Prevent if long-press selection just happened
    if (e.detail === 0 && e.pointerType === 'touch') return;
    const item = e.currentTarget;
    const id = item.dataset.id;
    
    // Check if Ctrl (Windows/Linux) or Cmd (Mac) key is pressed for multi-selection
    if (e.ctrlKey || e.metaKey) {
        // Toggle selection
        if (selectedEmailIds.has(id)) {
            selectedEmailIds.delete(id);
            item.classList.remove('selected');
        } else {
            selectedEmailIds.add(id);
            item.classList.add('selected');
        }
        updateDeleteButtonVisibility();
        e.stopPropagation();
        e.preventDefault();
        return;
    }
    
    // If any emails are already selected and this email is clicked without Ctrl/Cmd
    if (selectedEmailIds.size > 0) {
        // If this email is selected, toggle it
        if (selectedEmailIds.has(id)) {
            selectedEmailIds.delete(id);
            item.classList.remove('selected');
            updateDeleteButtonVisibility();
            e.stopPropagation();
            e.preventDefault();
            return;
        } else {
            // If this email is not selected, select it and deselect others
            clearSelections();
            selectedEmailIds.add(id);
            item.classList.add('selected');
            updateDeleteButtonVisibility();
            e.stopPropagation();
            e.preventDefault();
            return;
        }
    }
    
    // No selection mode: go to read mail
    window.location.href = '/read/' + item.dataset.id;
}

function handleEmailItemLongPress(e) {
    // Only on touch devices
    const item = e.currentTarget;
    longPressTimer = setTimeout(() => {
        const id = item.dataset.id;
        if (!selectedEmailIds.has(id)) {
            selectedEmailIds.add(id);
            item.classList.add('selected');
            updateDeleteButtonVisibility();
        }
    }, 500);
}
function handleEmailItemTouchEnd(e) {
    clearTimeout(longPressTimer);
}

function selectAllMails() {
    // Select all visible emails
    document.querySelectorAll('.email-item').forEach(item => {
        if (item.style.display !== 'none') {
            selectedEmailIds.add(item.dataset.id);
            item.classList.add('selected');
        }
    });
    updateDeleteButtonVisibility();
}

function deselectAllMails() {
    // Deselect all emails
    clearSelections();
}

function deleteSelectedMails() {
    // Example: Remove from UI. You'd do AJAX here in a real app.
    document.querySelectorAll('.email-item').forEach(item => {
        if (selectedEmailIds.has(item.dataset.id) && item.style.display !== 'none') {
            item.remove();
        }
    });
    clearSelections();
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.email-item').forEach(item => {
        // Make sure data-id is present
        if (!item.dataset.id) return;
        // Desktop: click to select/deselect if in selection mode, else open
        item.addEventListener('click', handleEmailItemClick);
        // Mobile: long-press to select
        item.addEventListener('touchstart', handleEmailItemLongPress);
        item.addEventListener('touchend', handleEmailItemTouchEnd);
    });
    // Delete button
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e){
            deleteSelectedMails();
        });
    }
});

// === NOTIFICATION SYSTEM ===

// Initialize notification system
async function initializeNotifications() {
    console.log('Initializing notification system...');
    
    // Check if notifications are supported
    if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return;
    }
    
    // Check if service workers are supported
    if (!('serviceWorker' in navigator)) {
        console.log('This browser does not support service workers');
        return;
    }
    
    try {
        // Register service worker
        serviceWorkerRegistration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker registered successfully:', serviceWorkerRegistration);
        
        // Check current notification permission
        notificationPermission = Notification.permission;
        console.log('Current notification permission:', notificationPermission);
        
        // Get notification status from server
        const status = await getNotificationStatus();
        isNotificationsEnabled = status.enabled;
        
        // Show notification prompt if permission is default
        if (notificationPermission === 'default') {
            showNotificationPrompt();
        } else if (notificationPermission === 'granted' && !status.subscribed) {
            // Subscribe if permission granted but not subscribed
            await subscribeToNotifications();
        }
        
        // Start periodic email checking if notifications are enabled
        if (isNotificationsEnabled && notificationPermission === 'granted') {
            startPeriodicEmailChecking();
        }
        
    } catch (error) {
        console.error('Error initializing notifications:', error);
    }
}

// Show notification permission prompt
function showNotificationPrompt() {
    const promptDiv = document.createElement('div');
    promptDiv.id = 'notification-prompt';
    promptDiv.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: #2196F3;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1001;
        font-size: 14px;
        max-width: 400px;
        text-align: center;
    `;
    
    promptDiv.innerHTML = `
        <div style="margin-bottom: 10px;">
            <i class="fa-solid fa-bell" style="margin-right: 8px;"></i>
            <strong>Enable Email Notifications?</strong>
        </div>
        <p style="margin: 8px 0; font-size: 13px;">Get notified when you receive new emails</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="enableNotifications()" style="background: white; color: #2196F3; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">Enable</button>
            <button onclick="dismissNotificationPrompt()" style="background: transparent; color: white; border: 1px solid white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Later</button>
        </div>
    `;
    
    document.body.appendChild(promptDiv);
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        dismissNotificationPrompt();
    }, 10000);
}

// Enable notifications
async function enableNotifications() {
    try {
        notificationPermission = await Notification.requestPermission();
        console.log('Notification permission result:', notificationPermission);
        
        if (notificationPermission === 'granted') {
            await subscribeToNotifications();
            showNotification('Notifications enabled! You\'ll now receive alerts for new emails.', 'success');
            startPeriodicEmailChecking();
        } else {
            showNotification('Notifications were not enabled. You can enable them later in your browser settings.', 'error');
        }
        
        dismissNotificationPrompt();
        
    } catch (error) {
        console.error('Error enabling notifications:', error);
        showNotification('Error enabling notifications', 'error');
        dismissNotificationPrompt();
    }
}

// Dismiss notification prompt
function dismissNotificationPrompt() {
    const prompt = document.getElementById('notification-prompt');
    if (prompt) {
        prompt.remove();
    }
}

// Subscribe to push notifications
async function subscribeToNotifications() {
    try {
        if (!serviceWorkerRegistration) {
            console.error('Service worker not registered');
            return;
        }
        
        // Get push subscription
        const subscription = await serviceWorkerRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: null // You would use your VAPID public key here
        });
        
        console.log('Push subscription:', subscription);
        
        // Send subscription to server
        const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            body: JSON.stringify({ subscription: subscription.toJSON() }),
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('Subscription saved successfully');
            isNotificationsEnabled = true;
        } else {
            console.error('Failed to save subscription:', result.error);
        }
        
    } catch (error) {
        console.error('Error subscribing to notifications:', error);
    }
}

// Get notification status from server
async function getNotificationStatus() {
    try {
        const response = await fetch('/api/notification-status', {
            credentials: 'same-origin'
        });
        return await response.json();
    } catch (error) {
        console.error('Error getting notification status:', error);
        return { enabled: false, subscribed: false };
    }
}

// Start periodic email checking
function startPeriodicEmailChecking() {
    // Check for new emails every 30 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/api/check-new-emails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCsrfToken()
                },
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            if (result.success && result.new_emails > 0) {
                console.log(`Found ${result.new_emails} new emails`);
                
                // Show browser notification for new emails
                if (notificationPermission === 'granted') {
                    showBrowserNotification(result.emails);
                }
                
                // Optionally refresh the email list
                // performRefresh();
            }
            
        } catch (error) {
            console.error('Error checking for new emails:', error);
        }
    }, 30000); // Check every 30 seconds
}

// Show browser notification for new emails
function showBrowserNotification(emails) {
    if (emails && emails.length > 0) {
        const firstEmail = emails[0];
        const title = `New email from ${firstEmail.sender}`;
        const body = firstEmail.subject || '(No subject)';
        
        const notification = new Notification(title, {
            body: body,
            icon: '/static/logo.png',
            badge: '/static/logo.png',
            tag: 'bharatmail-new-email',
            requireInteraction: true,
            actions: [
                {
                    action: 'open',
                    title: 'Open Email'
                },
                {
                    action: 'dismiss',
                    title: 'Dismiss'
                }
            ]
        });
        
        notification.onclick = function() {
            window.focus();
            if (firstEmail.id) {
                window.location.href = `/read/${firstEmail.id}`;
            } else {
                window.location.href = '/inbox';
            }
            notification.close();
        };
        
        // Auto-close after 10 seconds
        setTimeout(() => {
            notification.close();
        }, 10000);
    }
}

// Disable notifications
async function disableNotifications() {
    try {
        const response = await fetch('/api/unsubscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            isNotificationsEnabled = false;
            showNotification('Notifications disabled', 'success');
        }
        
    } catch (error) {
        console.error('Error disabling notifications:', error);
        showNotification('Error disabling notifications', 'error');
    }
}

// Initialize notifications when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize notification system after a short delay
    setTimeout(() => {
        initializeNotifications();
    }, 1000);
});

// Step 5: Scroll-to-refresh on mobile
let lastScrollTop = 0;
const emailList = document.querySelector('.email-list');
if(emailList) {
    emailList.addEventListener('scroll', function() {
        if(emailList.scrollTop === 0 && lastScrollTop > 0 && window.innerWidth <= 768) {
            refreshMails();
        }
        lastScrollTop = emailList.scrollTop;
    });
}
</script>

<!-- Floating Delete Button -->
<button id="deleteSelectedBtn" style="
    display: none;
    position: fixed;
    bottom: 90px;
    right: 20px;
    background-color: #e53935;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    font-weight: bold;
    cursor: pointer;
    z-index: 600;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-size: 16px;
"
>
    <i class="fa-solid fa-trash"></i> Delete
</button>

<!-- Floating Compose Button -->
<button class="compose-float-btn" onclick="openCompose()">
    <i class="fa-solid fa-pencil"></i> Compose
</button>

</body>
</html>
<style>
/* Account dropdown styling */
.active-account {
    background: linear-gradient(135deg, rgba(26,115,232,0.1), rgba(26,115,232,0.05));
    border: 2px solid rgba(26,115,232,0.3);
    border-radius: 8px;
    margin-bottom: 8px;
}

.active-indicator {
    color: #1a73e8;
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.accounts-section-header {
    padding: 8px 15px;
    font-weight: 600;
    font-size: 12px;
    color: #5f6368;
    border-bottom: 1px solid rgba(128,128,128,0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-item {
    transition: all 0.2s ease;
    border-radius: 6px;
    margin: 2px 6px;
}

.account-item:hover {
    background-color: rgba(26,115,232,0.08) !important;
    transform: translateX(2px);
}

.logout-btn {
    color: #e53935 !important;
    font-size: 16px;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.logout-btn:hover {
    background-color: rgba(229,57,53,0.1);
    transform: scale(1.1);
}

@media (prefers-color-scheme: dark) {
    .active-account {
        background: linear-gradient(135deg, rgba(26,115,232,0.2), rgba(26,115,232,0.1));
        border-color: rgba(26,115,232,0.4);
    }
    
    .accounts-section-header {
        color: #9aa0a6;
    }
    
    .account-item:hover {
        background-color: rgba(26,115,232,0.15) !important;
    }
}

/* Highlight selected emails */
.email-item.selected {
    background-color: #e3f0fd !important;
    /* fallback for light */
    border-left: 4px solid var(--accent);
}
@media (prefers-color-scheme: dark) {
    .email-item.selected {
        background-color: #174ea6 !important;
        color: #fff;
        border-left: 4px solid var(--accent);
    }
}
</style>