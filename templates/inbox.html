<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="csrf-token" content="{{ csrf_token() }}">
<meta name="theme-color" content="#2196F3">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="BharatMail">
<meta name="msapplication-TileColor" content="#2196F3">
<meta name="msapplication-tap-highlight" content="no">
<title>BharatMail - Inbox</title>
<link rel="manifest" href="/static/manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="/static/logo-192.png">
<link rel="apple-touch-icon" href="/static/logo-192.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script>
    // Make CSRF token available globally
    window.csrfToken = "{{ csrf_token() }}";
    
    // Notification system initialization
    let notificationPermission = 'default';
    let serviceWorkerRegistration = null;
    let isNotificationsEnabled = false;
</script>

<style>
    :root { --accent: #1a73e8; }

@media (prefers-color-scheme: dark) {
        body { background-color: #202124; color: #e8eaed; }
        .sidebar { background-color: #2d2e30; border-right: 1px solid #3c4043; }
        .email-item:hover { background-color: #3c4043; }
        .dropdown { background-color: #2d2e30; color: white; border: 1px solid #3c4043; }
        .dropdown-item:hover { background-color: #3c4043; }
        #mailSearch, #mobileMailSearch { background-color: #3c4043; color: white; border: 1px solid #5f6368; }
    }

@media (prefers-color-scheme: light) {
        body { background-color: #ffffff; color: #000000; }
        .sidebar { background-color: #f1f3f4; border-right: 1px solid #dadce0; }
        .email-item:hover { background-color: #f1f3f4; }
        .dropdown { background-color: white; color: black; border: 1px solid #dadce0; }
        .dropdown-item:hover { background-color: #f1f3f4; }
        #mailSearch, #mobileMailSearch { background-color: white; color: black; border: 1px solid #ccc; }
    }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    .sidebar {
        width: 250px;
        display: flex;
        flex-direction: column;
        padding: 10px;
        transition: transform 0.3s ease;
        background-color: inherit;
        z-index: 300;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        transform: translateX(0);
    }

    .sidebar.hidden {
        transform: translateX(-100%);
    }

    .logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
    }

    .logo img {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        margin-right: 8px;
        object-fit: cover;
    }

    .compose-btn {
        background-color: var(--accent);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 20px;
        margin-bottom: 20px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .menu-item {
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
    }

    .menu-item:hover {
        background-color: rgba(26, 115, 232, 0.1);
    }

    .top-bar {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0 20px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        z-index: 100;
        background: inherit;
        transition: left 0.3s ease;
    }

    .profile-pic, .profile-initials {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        object-fit: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        border: 3px solid rgba(255,255,255,0.15);
        transition: all 0.3s ease;
        overflow: hidden;
        letter-spacing: 0px;
        line-height: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
    
    .profile-pic:hover, .profile-initials:hover {
        transform: scale(1.05);
        border-color: rgba(255,255,255,0.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        width: 280px;
        border-radius: 8px;
        display: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 200;
    }

    .dropdown-header {
        padding: 15px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        text-align: center;
    }

    .dropdown-header img, .dropdown-header .profile-initials {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        margin: 0 auto 12px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 700;
        color: white;
        border: 3px solid rgba(255,255,255,0.1);
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        line-height: 1;
        letter-spacing: 0.5px;
    }

    .dropdown-item {
        padding: 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
    }

    .dropdown-item .remove-btn {
        background: none;
        border: none;
        color: red;
        cursor: pointer;
        font-size: 14px;
    }

    .email-section {
        margin-top: 50px;
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-left: 250px;
        transition: margin-left 0.3s ease;
        padding: 10px;
        box-sizing: border-box;
    }
    /* Floating Compose Button */
    .compose-float-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        font-weight: bold;
        cursor: pointer;
        z-index: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Top bar utility buttons */
    .top-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--accent);
        margin-left: 10px;
    }
    
    /* Mobile search container - hidden by default */
    .mobile-search-container {
        display: none;
    }

@media (max-width: 768px) {
        .top-btn { 
            display: none; 
        }
        
        /* Show select buttons on mobile when there are selections */
        .top-btn.mobile-select-btn { 
            display: flex !important;
            font-size: 16px;
            padding: 8px;
            margin-left: 5px;
            border-radius: 6px;
            background: rgba(26, 115, 232, 0.1);
        }
        
        /* Mobile search styling */
        .mobile-search-container {
            display: flex;
            flex: 1;
            max-width: 60%;
            position: relative;
            margin: 0 10px;
        }
        
        #mobileMailSearch {
            width: 100%;
            padding: 6px 10px 6px 30px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(128,128,128,0.3);
            background-color: rgba(255,255,255,0.1);
            color: inherit;
        }
        
        .mobile-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
            font-size: 14px;
            opacity: 0.7;
        }
        
        /* Hide desktop search on mobile */
        .desktop-only {
            display: none;
        }
        
        /* Mobile selection toolbar */
        .mobile-selection-toolbar {
            position: fixed;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .mobile-selection-toolbar.show {
            display: flex;
        }
        
        .mobile-selection-toolbar button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-left: 8px;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .mobile-selection-toolbar button:hover {
            background: rgba(255,255,255,0.3);
        }
    }

    .email-search {
        padding: 10px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
    }

    #mailSearch {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .email-list {
        flex: 1;
        overflow-y: auto;
    }

    .email-item {
        padding: 12px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        cursor: pointer;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transition: background-color 0.2s ease;
    }

    .email-avatar {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-initials {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 16px;
        text-transform: uppercase;
    }

    .draft-avatar {
        font-size: 18px;
    }

    .email-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .email-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
    }

    .email-sender {
        font-weight: 600;
        font-size: 14px;
        color: #202124;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .email-time {
        font-size: 12px;
        color: #5f6368;
        flex-shrink: 0;
    }

    .email-subject {
        font-weight: 500;
        font-size: 14px;
        color: #202124;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .email-preview {
        font-size: 13px;
        color: #5f6368;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.4;
    }

    /* Dark mode for email items */
    @media (prefers-color-scheme: dark) {
        .email-sender {
            color: #e8eaed;
        }
        
        .email-subject {
            color: #e8eaed;
        }
        
        .email-time,
        .email-preview {
            color: #9aa0a6;
        }
    }

    /* Sidebar toggle for all screens */
    .menu-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        font-size: 22px;
        cursor: pointer;
        color: var(--accent);
        background: transparent;
        border: none;
    }

    /* Responsive */
@media (max-width: 1024px) {
        .sidebar {
            /* Removed transform from here to avoid conflict */
        }
        .email-section {
            margin-left: 0;
        }
        .top-bar {
            left: 0 !important;
        }
        
        /* Show mobile search, hide desktop search */
        .mobile-search-container {
            display: flex;
        }
        .desktop-only {
            display: none;
        }
    }

    /* Compose Panel Styles */
    .compose-panel {
        position: fixed;
        top: 50px;
        right: 0;
        width: 400px;
        height: calc(100vh - 50px);
        background-color: inherit;
        border-left: 1px solid rgba(128,128,128,0.2);
        box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        padding: 15px;
        box-sizing: border-box;
        display: none;
        flex-direction: column;
        z-index: 400;
        overflow-y: auto;
    }

    /* Mobile compose panel */
    @media (max-width: 768px) {
        .compose-panel {
            width: 100vw;
            top: 0;
            left: 0;
            height: 100vh;
            border-left: none;
            box-shadow: none;
        }
        
        .dropdown {
            width: 90vw;
            max-width: 280px;
            right: 5vw;
        }
        
        .top-bar {
            padding: 0 15px;
        }
        
        .email-section {
            padding: 5px;
        }
    }

    .compose-panel header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .compose-panel header h2 {
        margin: 0;
        font-size: 18px;
    }

    .compose-panel header button.close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--accent);
    }

    .compose-panel .compose-brand {
        text-align: center;
        font-weight: bold;
        font-size: 20px;
        margin-bottom: 10px;
        letter-spacing: 1px;
        color: var(--accent);
    }

    .compose-panel form {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .compose-panel label {
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 4px;
        font-size: 14px;
    }

    .compose-panel input[type="text"],
    .compose-panel input[type="email"],
    .compose-panel textarea {
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
        box-sizing: border-box;
        background-color: inherit;
        color: inherit;
        resize: vertical;
    }

    .compose-panel textarea {
        min-height: 120px;
    }

    .compose-panel input[type="file"] {
        margin-top: 8px;
    }

    .compose-panel button.send-btn {
        margin-top: 15px;
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
        align-self: flex-end;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .compose-panel .attachment-preview {
        margin-top: 8px;
        margin-bottom: 8px;
    }
    .compose-panel .attachment-preview div {
        display: inline-flex;
        align-items: center;
        background: rgba(26,115,232,0.08);
        border-radius: 12px;
        padding: 4px 10px;
        margin-right: 6px;
        margin-bottom: 4px;
        font-size: 13px;
    }
    .compose-panel .attachment-preview button {
        background: none;
        border: none;
        color: #e53935;
        margin-left: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }

    /* Auto-complete styles for compose panel */
    .compose-panel .autocomplete-container {
        position: relative;
        width: 100%;
    }

    .compose-panel .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
    }

    .compose-panel .autocomplete-suggestion {
        padding: 10px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background-color 0.2s;
    }

    .compose-panel .autocomplete-suggestion:hover {
        background-color: #f5f5f5;
    }

    .compose-panel .autocomplete-suggestion.selected {
        background-color: #e3f2fd;
    }

    .compose-panel .suggestion-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 14px;
        flex-shrink: 0;
    }

    .compose-panel .suggestion-info {
        flex: 1;
        min-width: 0;
    }

    .compose-panel .suggestion-name {
        font-weight: 500;
        font-size: 14px;
        color: #202124;
        margin-bottom: 2px;
    }

    .compose-panel .suggestion-email {
        font-size: 12px;
        color: #5f6368;
    }

    .compose-panel .recipient-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
        padding: 8px 12px;
        background-color: rgba(26, 115, 232, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(26, 115, 232, 0.2);
    }

    .compose-panel .recipient-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 14px;
        flex-shrink: 0;
    }

    .compose-panel .recipient-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .compose-panel .recipient-name {
        font-weight: 600;
        font-size: 14px;
        color: #202124;
    }

    .compose-panel .recipient-email {
        font-size: 12px;
        color: #5f6368;
    }

    /* Dark mode for compose panel autocomplete */
    @media (prefers-color-scheme: dark) {
        .compose-panel .autocomplete-suggestions {
            background: #242526;
            border-color: #3a3b3c;
            color: #e8eaed;
        }
        
        .compose-panel .autocomplete-suggestion:hover {
            background-color: #3a3b3c;
        }
        
        .compose-panel .autocomplete-suggestion.selected {
            background-color: #174ea6;
        }
        
        .compose-panel .suggestion-name {
            color: #e8eaed;
        }
        
        .compose-panel .suggestion-email {
            color: #9aa0a6;
        }
        
        .compose-panel .recipient-info {
            background-color: rgba(26, 115, 232, 0.1);
            border-color: rgba(26, 115, 232, 0.3);
        }
        
        .compose-panel .recipient-name {
            color: #e8eaed;
        }
        
        .compose-panel .recipient-email {
            color: #9aa0a6;
        }
    }
</style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="/static/logo.png" alt="BharatMail Logo">
            BharatMail
        </div>
        <button class="compose-btn" onclick="openCompose()">
            <i class="fa-solid fa-pencil"></i> Compose
        </button>
        <div class="menu-item" onclick="filterCategory('All')" data-category="All">All Mail</div>
        <div class="menu-item" onclick="filterCategory('Inbox')" data-category="Inbox">Inbox</div>
        <div class="menu-item" onclick="filterCategory('Promotions')" data-category="Promotions">Promotions</div>
        <div class="menu-item" onclick="filterCategory('Social')" data-category="Social">Social</div>
        <div class="menu-item" onclick="filterCategory('Updates')" data-category="Updates">Updates</div>
        <div class="menu-item" onclick="filterCategory('Sent')" data-category="Sent">Sent</div>
        <div class="menu-item" onclick="filterCategory('Drafts')" data-category="Drafts">Drafts</div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="menu-toggle-btn" aria-label="Toggle Menu" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </button>
        <button class="top-btn" onclick="refreshMails()" title="Refresh"><i class="fa-solid fa-arrows-rotate"></i></button>
        <button class="top-btn" onclick="selectAllMails()" title="Select All Visible Emails"><i class="fa-solid fa-check"></i></button>
        <button class="top-btn" onclick="deselectAllMails()" title="Deselect All"><i class="fa-solid fa-xmark"></i></button>
        <div id="selectionInfo" style="display:none; margin-left: 15px; font-size: 12px; color: var(--accent); background: rgba(26,115,232,0.1); padding: 4px 8px; border-radius: 12px;">
            <span id="selectedCount">0</span> selected
        </div>
        
        <!-- Mobile Search Bar - Shown only on mobile devices -->
        <div class="mobile-search-container">
            <input type="text" id="mobileMailSearch" placeholder="Search mails...">
            <i class="fa-solid fa-search mobile-search-icon"></i>
        </div>
        
        <div style="flex:1"></div>
        {% if user_profile_pic %}
            <img src="{{ user_profile_pic }}" alt="Profile" class="profile-pic" onclick="toggleDropdown()">
        {% else %}
            {% set name_parts = user_name.split() %}
            {% if name_parts|length >= 2 %}
                {% set initials = (name_parts[0][0] ~ name_parts[-1][0])|upper %}
            {% elif name_parts|length == 1 %}
                {% set initials = name_parts[0][0:2]|upper %}
            {% else %}
                {% set initials = user_email[0]|upper %}
            {% endif %}
            <div class="profile-initials" style="background-color: {{ profile_bg_color }};" onclick="toggleDropdown()">
                {{ initials }}
            </div>
        {% endif %}
        <div class="dropdown" id="profileDropdown">
            <!-- Current Active Account -->
            <div class="dropdown-header active-account">
                {% if user_profile_pic %}
                    <img src="{{ user_profile_pic }}" alt="Profile">
                {% else %}
                    <div class="profile-initials" style="background-color: {{ profile_bg_color }};">
                        {{ initials }}
                    </div>
                {% endif %}
                <strong>{{ user_name }}</strong>
                <small>{{ user_email }}</small>
                <div class="active-indicator"><i class="fa-solid fa-check-circle"></i> Currently active</div>
            </div>

            <!-- Other Available Accounts -->
            {% if other_accounts %}
            <div class="accounts-section-header">Switch to:</div>
            {% for acc in other_accounts %}
            <div class="dropdown-item account-item">
                <span onclick="window.location.href='/switch_account/{{ acc.email }}'" style="flex:1;cursor:pointer;" title="Switch to this account">
                    <strong>{{ acc.name }}</strong><br><small>{{ acc.email }}</small>
                </span>
                <i class="fa-solid fa-right-from-bracket logout-btn" title="Remove this account" 
                   onclick="window.location.href='/logout/{{ acc.email }}'"></i>
            </div>
            {% endfor %}
            {% endif %}

            <div class="dropdown-item" onclick="window.location.href='/login?add=1'">
                <i class="fa-solid fa-plus"></i> Add account
            </div>
            <div class="dropdown-item" onclick="window.location.href='/manage_profile'">
                <i class="fa-solid fa-user-gear"></i> Manage Profile
            </div>
            <div class="dropdown-item" onclick="showMobileNotificationSettings()">
                <i class="fa-solid fa-bell"></i> Notification Settings
            </div>
            <div class="dropdown-item" onclick="window.location.href='/logout'">
                <i class="fa-solid fa-right-from-bracket"></i> Logout
            </div>
        </div>
    </div>

    <!-- Compose Panel -->
    <div class="compose-panel" id="composePanel">
        <div class="compose-brand">BharatMail</div>
        <header>
            <h2>New Message</h2>
            <button class="close-btn" aria-label="Close Compose" onclick="closeCompose()">&times;</button>
        </header>
        <form id="composeForm" action="/send_mail" method="post" enctype="multipart/form-data">
            <label for="fromEmail">From</label>
            <input type="email" id="fromEmail" name="from" value="{{ user_email }}" readonly>

            <label for="toEmail">To</label>
            <div class="autocomplete-container">
                <input type="email" id="toEmail" name="to" placeholder="Recipient email" required>
                <div class="autocomplete-suggestions" id="inboxAutocompleteSuggestions"></div>
                <div class="recipient-info" id="inboxRecipientInfo" style="display: none;">
                    <div class="recipient-avatar" id="inboxRecipientAvatar"></div>
                    <div class="recipient-details">
                        <span class="recipient-name" id="inboxRecipientName"></span>
                        <span class="recipient-email" id="inboxRecipientEmail"></span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center; margin-bottom:4px;">
                <button type="button" onclick="toggleCC()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;padding:0;">CC</button>
                <button type="button" onclick="toggleBCC()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;padding:0;">BCC</button>
            </div>
            <div id="ccRow" style="display:none;">
                <label for="ccEmail" style="margin-top:0;">CC</label>
                <input type="email" id="ccEmail" name="cc" placeholder="CC email(s)">
            </div>
            <div id="bccRow" style="display:none;">
                <label for="bccEmail" style="margin-top:0;">BCC</label>
                <input type="email" id="bccEmail" name="bcc" placeholder="BCC email(s)">
            </div>

            <label for="subject">Subject</label>
            <input type="text" id="subject" name="subject" placeholder="Subject">

            <label for="messageBody">Message</label>
            <textarea id="messageBody" name="message" placeholder="Write your message here..."></textarea>

            <label for="attachments">Attachments</label>
            <input type="file" id="attachments" name="attachments" multiple>
            <div class="attachment-preview" id="attachmentList"></div>

            <button type="submit" class="send-btn"><i class="fa-solid fa-paper-plane"></i> Send</button>
        </form>
    </div>

    <!-- Mobile Selection Toolbar -->
    <div class="mobile-selection-toolbar" id="mobileSelectionToolbar">
        <div>
            <span id="mobileSelectedCount">0</span> selected
        </div>
        <div>
            <button onclick="selectAllMails()" id="mobileSelectAllBtn"><i class="fa-solid fa-check-double"></i></button>
            <button onclick="deleteSelectedMails()"><i class="fa-solid fa-trash"></i></button>
            <button onclick="deselectAllMails()"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- Email Section -->
    <div class="email-section">
        <!-- Desktop Mail Search - Hidden on mobile -->
        <div class="email-search desktop-only">
            <input type="text" id="mailSearch" placeholder="Search mails...">
        </div>

        <!-- Email List -->
        <div class="email-list" id="mailList">
            <!-- Inbox Messages -->
            {% for m in categorized_mails['Inbox'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Inbox" data-timestamp="{{ m.timestamp }}">
                <div class="email-avatar">
                    {% if m.sender_avatar %}
                        <img src="{{ m.sender_avatar }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <div class="avatar-initials" style="background-color: {{ m.sender_avatar_color }};">
                            {{ m.sender_initials }}
                        </div>
                    {% endif %}
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <strong class="email-sender">{{ m.sender_name or m.sender }}</strong>
                        <span class="email-time">{{ m.formatted_time }}</span>
                    </div>
                    <div class="email-subject">{{ m.subject or '(No subject)' }}</div>
                    <div class="email-preview">{{ m.message_preview }}</div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Promotions Messages -->
            {% for m in categorized_mails['Promotions'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Promotions" data-timestamp="{{ m.timestamp }}">
                <div class="email-avatar">
                    {% if m.sender_avatar %}
                        <img src="{{ m.sender_avatar }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <div class="avatar-initials" style="background-color: {{ m.sender_avatar_color }};">
                            {{ m.sender_initials }}
                        </div>
                    {% endif %}
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <strong class="email-sender">{{ m.sender_name or m.sender }}</strong>
                        <span class="email-time">{{ m.formatted_time }}</span>
                    </div>
                    <div class="email-subject">{{ m.subject or '(No subject)' }}</div>
                    <div class="email-preview">{{ m.message_preview }}</div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Social Messages -->
            {% for m in categorized_mails['Social'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Social" data-timestamp="{{ m.timestamp }}">
                <div class="email-avatar">
                    {% if m.sender_avatar %}
                        <img src="{{ m.sender_avatar }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <div class="avatar-initials" style="background-color: {{ m.sender_avatar_color }};">
                            {{ m.sender_initials }}
                        </div>
                    {% endif %}
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <strong class="email-sender">{{ m.sender_name or m.sender }}</strong>
                        <span class="email-time">{{ m.formatted_time }}</span>
                    </div>
                    <div class="email-subject">{{ m.subject or '(No subject)' }}</div>
                    <div class="email-preview">{{ m.message_preview }}</div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Updates Messages -->
            {% for m in categorized_mails['Updates'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Updates" data-timestamp="{{ m.timestamp }}">
                <div class="email-avatar">
                    {% if m.sender_avatar %}
                        <img src="{{ m.sender_avatar }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <div class="avatar-initials" style="background-color: {{ m.sender_avatar_color }};">
                            {{ m.sender_initials }}
                        </div>
                    {% endif %}
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <strong class="email-sender">{{ m.sender_name or m.sender }}</strong>
                        <span class="email-time">{{ m.formatted_time }}</span>
                    </div>
                    <div class="email-subject">{{ m.subject or '(No subject)' }}</div>
                    <div class="email-preview">{{ m.message_preview }}</div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Sent Messages -->
            {% for m in categorized_mails['Sent'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Sent" data-timestamp="{{ m.timestamp }}">
                <div class="email-avatar">
                    {% if m.receiver_avatar %}
                        <img src="{{ m.receiver_avatar }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <div class="avatar-initials" style="background-color: {{ m.receiver_avatar_color }};">
                            {{ m.receiver_initials }}
                        </div>
                    {% endif %}
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <strong class="email-sender">To: {{ m.receiver_name or m.receiver }}</strong>
                        <span class="email-time">{{ m.formatted_time }}</span>
                    </div>
                    <div class="email-subject">{{ m.subject or '(No subject)' }}</div>
                    <div class="email-preview">{{ m.message_preview }}</div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Draft Messages -->
            {% for m in categorized_mails['Drafts'] %}
            <div class="email-item" data-id="{{ m.id }}" data-category="Drafts" data-timestamp="{{ m.timestamp }}">
                <div class="email-avatar">
                    <div class="avatar-initials draft-avatar" style="background-color: #FF9800;">
                        <i class="fa-solid fa-file-lines"></i>
                    </div>
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <strong class="email-sender">Draft to: {{ m.receiver_name or m.receiver or 'No recipient' }}</strong>
                        <span class="email-time">{{ m.formatted_time }}</span>
                    </div>
                    <div class="email-subject">{{ m.subject or '(No subject)' }}</div>
                    <div class="email-preview">{{ m.message_preview }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

<script>
function toggleDropdown() {
    const menu = document.getElementById('profileDropdown');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

document.addEventListener('click', function(e) {
    const menu = document.getElementById('profileDropdown');
    if (!e.target.closest('.profile-pic') && !e.target.closest('.profile-initials') && !e.target.closest('.dropdown')) {
        menu.style.display = 'none';
    }
});

function removeAccount(id) {
    window.location.href = '/switch_account/' + id;
}

// Step 3: JS function to filter emails
function filterCategory(category) {
    document.querySelectorAll('.email-item').forEach(item => {
        if(category === 'All' || item.dataset.category === category) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
    updateDeleteButtonVisibility();
}

// Mail search functionality for both desktop and mobile
function setupSearchListeners() {
    const desktopSearch = document.getElementById('mailSearch');
    const mobileSearch = document.getElementById('mobileMailSearch');
    
    const performSearch = function(filter) {
        filter = filter.toLowerCase();
        document.querySelectorAll('#mailList .email-item').forEach(function(item) {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(filter) ? '' : 'none';
        });
        updateDeleteButtonVisibility();
    };
    
    if (desktopSearch) {
        desktopSearch.addEventListener('input', function() {
            performSearch(this.value);
            // Sync with mobile search
            if (mobileSearch) mobileSearch.value = this.value;
        });
    }
    
    if (mobileSearch) {
        mobileSearch.addEventListener('input', function() {
            performSearch(this.value);
            // Sync with desktop search
            if (desktopSearch) desktopSearch.value = this.value;
        });
    }
}

// Initialize search functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupSearchListeners();
});

// Sidebar toggle for all screens
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('hidden');
    const topBar = document.querySelector('.top-bar');
    if (sidebar.classList.contains('hidden')) {
        topBar.style.left = '0';
        document.querySelector('.email-section').style.marginLeft = '0';
    } else {
        topBar.style.left = '250px';
        document.querySelector('.email-section').style.marginLeft = '250px';
    }
}

// Initialize sidebar as visible on desktop
window.addEventListener('load', function() {
    if (window.innerWidth > 1024) {
        document.getElementById('sidebar').classList.remove('hidden');
        document.querySelector('.top-bar').style.left = '250px';
        document.querySelector('.email-section').style.marginLeft = '250px';
    } else {
        document.getElementById('sidebar').classList.add('hidden');
        document.querySelector('.top-bar').style.left = '0';
        document.querySelector('.email-section').style.marginLeft = '0';
    }
});

// Close sidebar when clicking outside on mobile
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.menu-toggle-btn');
    if (window.innerWidth <= 1024) {
        if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
            sidebar.classList.add('hidden');
            const topBar = document.querySelector('.top-bar');
            topBar.style.left = '0';
            document.querySelector('.email-section').style.marginLeft = '0';
        }
    }
});

// Compose panel control
function openCompose() {
    document.getElementById('composePanel').style.display = 'flex';
    // Initialize auto-complete for inbox compose panel
    initializeInboxComposeAutoComplete();
}

function closeCompose() {
    document.getElementById('composePanel').style.display = 'none';
}

// Auto-complete functionality for inbox compose panel
let inboxUsers = [];
let inboxSelectedSuggestionIndex = -1;

// Initialize auto-complete for inbox compose panel
async function initializeInboxComposeAutoComplete() {
    try {
        console.log('Fetching users for inbox compose auto-complete...');
        const response = await fetch('/api/users');
        console.log('Inbox compose response status:', response.status);
        if (response.ok) {
            inboxUsers = await response.json();
            console.log('Inbox compose users fetched:', inboxUsers.length);
            setupInboxComposeAutoComplete();
        } else {
            console.error('Failed to fetch users for inbox compose:', response.status);
        }
    } catch (error) {
        console.error('Error fetching users for inbox compose:', error);
    }
}

// Setup auto-complete for inbox compose panel
function setupInboxComposeAutoComplete() {
    const toEmailInput = document.getElementById('toEmail');
    const inboxAutocompleteSuggestions = document.getElementById('inboxAutocompleteSuggestions');
    
    if (!toEmailInput || !inboxAutocompleteSuggestions) return;
    
    // Event listeners for inbox compose auto-complete
    toEmailInput.addEventListener('input', (e) => {
        const value = e.target.value;
        console.log('Inbox compose input value:', value);
        
        // Hide recipient info if input is cleared
        if (!value) {
            hideInboxRecipientInfo();
        }
        
        // Auto-complete @bharatmail.in when @ is typed
        if (value.includes('@') && !value.includes('@bharatmail.in')) {
            const atIndex = value.lastIndexOf('@');
            const beforeAt = value.substring(0, atIndex);
            const afterAt = value.substring(atIndex + 1);
            
            // If just @ is typed, auto-complete with bharatmail.in
            if (afterAt === '') {
                const newValue = beforeAt + '@bharatmail.in';
                toEmailInput.value = newValue;
                // Set cursor position after @
                toEmailInput.setSelectionRange(atIndex + 1, atIndex + 1);
            }
        }
        
        showInboxSuggestions(value);
    });
    
    toEmailInput.addEventListener('keydown', handleInboxKeydown);
    
    toEmailInput.addEventListener('focus', () => {
        if (toEmailInput.value) {
            showInboxSuggestions(toEmailInput.value);
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!toEmailInput.contains(e.target) && !inboxAutocompleteSuggestions.contains(e.target)) {
            inboxAutocompleteSuggestions.style.display = 'none';
            inboxSelectedSuggestionIndex = -1;
        }
    });
}

// Show suggestions for inbox compose
function showInboxSuggestions(query) {
    console.log('Showing inbox suggestions for:', query);
    if (!query) {
        document.getElementById('inboxAutocompleteSuggestions').style.display = 'none';
        return;
    }
    
    const atIndex = query.lastIndexOf('@');
    const beforeAt = query.substring(0, atIndex);
    const afterAt = query.substring(atIndex + 1);
    
    // If @ is typed, auto-complete with bharatmail.in
    if (afterAt === '') {
        const suggestions = inboxUsers.filter(user => 
            user.email.startsWith(beforeAt + '@bharatmail.in') ||
            user.name.toLowerCase().includes(beforeAt.toLowerCase())
        ).slice(0, 5);
        
        displayInboxSuggestions(suggestions, beforeAt + '@bharatmail.in');
        return;
    }
    
    // If typing after @, filter by domain
    if (afterAt && afterAt.length > 0) {
        const suggestions = inboxUsers.filter(user => 
            user.email.toLowerCase().includes(query.toLowerCase()) ||
            user.name.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 5);
        
        displayInboxSuggestions(suggestions, query);
        return;
    }
    
    // Filter users based on query (before @)
    const suggestions = inboxUsers.filter(user => 
        user.email.toLowerCase().includes(query.toLowerCase()) ||
        user.name.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 5);
    
    displayInboxSuggestions(suggestions, query);
}

// Display suggestions for inbox compose
function displayInboxSuggestions(suggestions, query) {
    const inboxAutocompleteSuggestions = document.getElementById('inboxAutocompleteSuggestions');
    console.log('Displaying inbox suggestions:', suggestions.length, 'for query:', query);
    
    if (suggestions.length === 0) {
        inboxAutocompleteSuggestions.style.display = 'none';
        return;
    }
    
    inboxAutocompleteSuggestions.innerHTML = '';
    
    suggestions.forEach((user, index) => {
        const avatar = generateAvatar(user.name, user.email);
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'autocomplete-suggestion';
        suggestionDiv.setAttribute('data-index', index);
        suggestionDiv.setAttribute('data-email', user.email);
        
        suggestionDiv.innerHTML = `
            <div class="suggestion-avatar" style="background-color: ${avatar.backgroundColor}">
                ${avatar.initials}
            </div>
            <div class="suggestion-info">
                <div class="suggestion-name">${user.name}</div>
                <div class="suggestion-email">${user.email}</div>
            </div>
        `;
        
        suggestionDiv.addEventListener('click', () => {
            selectInboxSuggestion(user.email);
        });
        
        suggestionDiv.addEventListener('mouseenter', () => {
            inboxSelectedSuggestionIndex = index;
            updateInboxSelectedSuggestion();
        });
        
        inboxAutocompleteSuggestions.appendChild(suggestionDiv);
    });
    
    inboxAutocompleteSuggestions.style.display = 'block';
    inboxSelectedSuggestionIndex = -1;
}

// Update selected suggestion for inbox compose
function updateInboxSelectedSuggestion() {
    const suggestions = document.querySelectorAll('#inboxAutocompleteSuggestions .autocomplete-suggestion');
    suggestions.forEach((suggestion, index) => {
        if (index === inboxSelectedSuggestionIndex) {
            suggestion.classList.add('selected');
        } else {
            suggestion.classList.remove('selected');
        }
    });
}

// Select suggestion for inbox compose
function selectInboxSuggestion(email) {
    const toEmailInput = document.getElementById('toEmail');
    toEmailInput.value = email;
    document.getElementById('inboxAutocompleteSuggestions').style.display = 'none';
    
    // Show recipient info
    const user = inboxUsers.find(u => u.email === email);
    if (user) {
        showInboxRecipientInfo(user);
    } else {
        hideInboxRecipientInfo();
    }
    
    toEmailInput.focus();
}

// Show recipient info for inbox compose
function showInboxRecipientInfo(user) {
    const recipientInfo = document.getElementById('inboxRecipientInfo');
    const recipientAvatar = document.getElementById('inboxRecipientAvatar');
    const recipientName = document.getElementById('inboxRecipientName');
    const recipientEmail = document.getElementById('inboxRecipientEmail');
    
    const avatar = generateAvatar(user.name, user.email);
    
    recipientAvatar.style.backgroundColor = avatar.backgroundColor;
    recipientAvatar.textContent = avatar.initials;
    recipientName.textContent = user.name;
    recipientEmail.textContent = user.email;
    
    recipientInfo.style.display = 'flex';
}

// Hide recipient info for inbox compose
function hideInboxRecipientInfo() {
    const recipientInfo = document.getElementById('inboxRecipientInfo');
    recipientInfo.style.display = 'none';
}

// Handle keyboard navigation for inbox compose
function handleInboxKeydown(event) {
    const suggestions = document.querySelectorAll('#inboxAutocompleteSuggestions .autocomplete-suggestion');
    
    if (suggestions.length === 0) return;
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            inboxSelectedSuggestionIndex = Math.min(inboxSelectedSuggestionIndex + 1, suggestions.length - 1);
            updateInboxSelectedSuggestion();
            break;
            
        case 'ArrowUp':
            event.preventDefault();
            inboxSelectedSuggestionIndex = Math.max(inboxSelectedSuggestionIndex - 1, -1);
            updateInboxSelectedSuggestion();
            break;
            
        case 'Enter':
            event.preventDefault();
            if (inboxSelectedSuggestionIndex >= 0 && suggestions[inboxSelectedSuggestionIndex]) {
                const email = suggestions[inboxSelectedSuggestionIndex].getAttribute('data-email');
                selectInboxSuggestion(email);
            }
            break;
            
        case 'Escape':
            document.getElementById('inboxAutocompleteSuggestions').style.display = 'none';
            inboxSelectedSuggestionIndex = -1;
            break;
    }
}

// Compose attachment preview and removal
document.addEventListener('DOMContentLoaded', function() {
    var attachInput = document.getElementById('attachments');
    var attachList = document.getElementById('attachmentList');
    if (attachInput && attachList) {
        attachInput.addEventListener('change', function(){
            attachList.innerHTML = '';
            Array.from(this.files).forEach((file, index) => {
                const div = document.createElement('div');
                div.textContent = file.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.onclick = () => {
                    const dt = new DataTransfer();
                    Array.from(attachInput.files).forEach((f,i) => { if(i!==index) dt.items.add(f) });
                    attachInput.files = dt.files;
                    // re-trigger change to update
                    const event = new Event('change', {bubbles:true});
                    attachInput.dispatchEvent(event);
                };
                div.appendChild(removeBtn);
                attachList.appendChild(div);
            });
        });
    }
});

// CC/BCC toggle
function toggleCC() {
    var ccRow = document.getElementById('ccRow');
    if (ccRow) ccRow.style.display = ccRow.style.display === 'none' ? 'block' : 'none';
}
function toggleBCC() {
    var bccRow = document.getElementById('bccRow');
    if (bccRow) bccRow.style.display = bccRow.style.display === 'none' ? 'block' : 'none';
}
// Hide CC/BCC initially
document.addEventListener('DOMContentLoaded', function() {
    var ccRow = document.getElementById('ccRow');
    var bccRow = document.getElementById('bccRow');
    if(ccRow) ccRow.style.display = 'none';
    if(bccRow) bccRow.style.display = 'none';
});

// Debounce mechanism
let refreshTimeout = null;
let lastRefreshTime = 0;
const MIN_REFRESH_INTERVAL = 2000; // 2 seconds

function refreshMails() {
    const now = Date.now();
    
    // Debounce: prevent too frequent refreshes
    if (now - lastRefreshTime < MIN_REFRESH_INTERVAL) {
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
        }
        refreshTimeout = setTimeout(() => {
            performRefresh();
        }, MIN_REFRESH_INTERVAL - (now - lastRefreshTime));
        return;
    }
    
    performRefresh();
}

function performRefresh() {
    const refreshBtn = document.querySelector('button[onclick="refreshMails()"]');
    const icon = refreshBtn.querySelector('i');
    
    // Prevent multiple simultaneous refreshes
    if (refreshBtn.disabled) {
        return;
    }
    
    // Add visual feedback
    icon.style.animation = 'spin 1s linear infinite';
    refreshBtn.disabled = true;
    refreshBtn.style.opacity = '0.6';
    refreshBtn.title = 'Refreshing...';
    
    // Add CSS for spin animation if it doesn't exist
    if (!document.querySelector('#refresh-animation-style')) {
        const style = document.createElement('style');
        style.id = 'refresh-animation-style';
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Get CSRF token
    const csrfToken = getCsrfToken();
    
    // Make secure AJAX request
    fetch('/api/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            updateEmailList(data.categorized_mails);
            showRefreshSuccess(data.total_messages);
            lastRefreshTime = Date.now();
        } else {
            throw new Error('Refresh failed');
        }
    })
    .catch(error => {
        console.error('Refresh error:', error);
        showRefreshError(error.message);
        // Fallback to page reload if AJAX fails
        if (error.message.includes('CSRF') || error.message.includes('401')) {
            setTimeout(() => window.location.reload(), 1000);
        }
    })
    .finally(() => {
        // Reset button state
        icon.style.animation = '';
        refreshBtn.disabled = false;
        refreshBtn.style.opacity = '1';
        refreshBtn.title = 'Refresh';
    });
}

// Helper function to get CSRF token
function getCsrfToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    // Fallback: try to get from a hidden form field
    const hiddenField = document.querySelector('input[name="csrf_token"]');
    if (hiddenField) {
        return hiddenField.value;
    }
    
    // Last resort: try to get from template variable (if available)
    return window.csrfToken || '';
}

// Update email list with new data
function updateEmailList(categorizedMails) {
    const mailListElement = document.getElementById('mailList');
    if (!mailListElement) return;
    
    // Clear existing emails
    mailListElement.innerHTML = '';
    
    // Add emails by category
    const categories = ['Inbox', 'Promotions', 'Social', 'Updates', 'Sent', 'Drafts'];
    
    categories.forEach(category => {
        const mails = categorizedMails[category] || [];
        mails.forEach(mail => {
            const emailDiv = document.createElement('div');
            emailDiv.className = 'email-item';
            emailDiv.setAttribute('data-id', mail.id);
            emailDiv.setAttribute('data-category', category);
            
            let senderText = '';
            if (category === 'Sent') {
                senderText = `To: ${mail.receiver}`;
            } else if (category === 'Drafts') {
                senderText = `Draft to: ${mail.receiver || 'No recipient'}`;
            } else {
                senderText = mail.sender;
            }
            
            const subjectText = mail.subject || (category === 'Drafts' ? '(No subject)' : '');
            
            emailDiv.innerHTML = `
                <strong>${senderText}</strong>
                <span>${subjectText}</span>
            `;
            
            // Add event listeners
            emailDiv.addEventListener('click', handleEmailItemClick);
            emailDiv.addEventListener('touchstart', handleEmailItemLongPress);
            emailDiv.addEventListener('touchend', handleEmailItemTouchEnd);
            
            mailListElement.appendChild(emailDiv);
        });
    });
    
    // Update visibility based on current filter
    const activeFilter = document.querySelector('.menu-item.active');
    if (activeFilter) {
        const category = activeFilter.textContent.trim();
        if (category !== 'All Mail') {
            filterCategory(category);
        }
    }
    
    // Clear any existing selections
    clearSelections();
}

// Show success message
function showRefreshSuccess(totalMessages) {
    showNotification(`Refreshed successfully! Found ${totalMessages} messages.`, 'success');
}

// Show error message
function showRefreshError(errorMessage) {
    showNotification(`Refresh failed: ${errorMessage}`, 'error');
}

// Generic notification function
function showNotification(message, type = 'info') {
    // Remove existing notification
    const existing = document.querySelector('.refresh-notification');
    if (existing) {
        existing.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `refresh-notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// --- Email Selection and Delete Button Logic ---
const selectedEmailIds = new Set();
let longPressTimer = null;

function updateDeleteButtonVisibility() {
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const selectionInfo = document.getElementById('selectionInfo');
    const selectedCount = document.getElementById('selectedCount');
    const mobileToolbar = document.getElementById('mobileSelectionToolbar');
    const mobileSelectedCount = document.getElementById('mobileSelectedCount');
    
    if (!deleteBtn || !selectionInfo || !selectedCount || !mobileToolbar || !mobileSelectedCount) return;
    
    // Count visible selected emails
    let visibleSelectedCount = 0;
    document.querySelectorAll('.email-item').forEach(item => {
        if (item.style.display !== 'none' && selectedEmailIds.has(item.dataset.id)) {
            visibleSelectedCount++;
        }
    });
    
    // Show/hide delete button and selection info
    const hasSelection = visibleSelectedCount > 0;
    deleteBtn.style.display = hasSelection ? 'flex' : 'none';
    selectionInfo.style.display = hasSelection ? 'block' : 'none';
    selectedCount.textContent = visibleSelectedCount;

    // Show/hide mobile selection toolbar
    if (window.innerWidth <= 768) {
        if (hasSelection) {
            mobileToolbar.classList.add('show');
            mobileSelectedCount.textContent = visibleSelectedCount;
        } else {
            mobileToolbar.classList.remove('show');
        }
    } else {
        mobileToolbar.classList.remove('show');
    }
}

function clearSelections() {
    selectedEmailIds.clear();
    document.querySelectorAll('.email-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    updateDeleteButtonVisibility();
}

function handleEmailItemClick(e) {
    // Prevent if long-press selection just happened
    if (e.detail === 0 && e.pointerType === 'touch') return;
    const item = e.currentTarget;
    const id = item.dataset.id;
    
    // Check if Ctrl (Windows/Linux) or Cmd (Mac) key is pressed for multi-selection
    if (e.ctrlKey || e.metaKey) {
        // Toggle selection
        if (selectedEmailIds.has(id)) {
            selectedEmailIds.delete(id);
            item.classList.remove('selected');
        } else {
            selectedEmailIds.add(id);
            item.classList.add('selected');
        }
        updateDeleteButtonVisibility();
        e.stopPropagation();
        e.preventDefault();
        return;
    }
    
    // If any emails are already selected and this email is clicked without Ctrl/Cmd
    if (selectedEmailIds.size > 0) {
        // If this email is selected, toggle it
        if (selectedEmailIds.has(id)) {
            selectedEmailIds.delete(id);
            item.classList.remove('selected');
            updateDeleteButtonVisibility();
            e.stopPropagation();
            e.preventDefault();
            return;
        } else {
            // If this email is not selected, select it and deselect others
            clearSelections();
            selectedEmailIds.add(id);
            item.classList.add('selected');
            updateDeleteButtonVisibility();
            e.stopPropagation();
            e.preventDefault();
            return;
        }
    }
    
    // No selection mode: go to read mail
    window.location.href = '/read/' + item.dataset.id;
}

function handleEmailItemLongPress(e) {
    // Only on touch devices
    const item = e.currentTarget;
    longPressTimer = setTimeout(() => {
        const id = item.dataset.id;
        if (!selectedEmailIds.has(id)) {
            selectedEmailIds.add(id);
            item.classList.add('selected');
            updateDeleteButtonVisibility();
        }
    }, 500);
}
function handleEmailItemTouchEnd(e) {
    clearTimeout(longPressTimer);
}

function selectAllMails() {
    // Select all visible emails
    document.querySelectorAll('.email-item').forEach(item => {
        if (item.style.display !== 'none') {
            selectedEmailIds.add(item.dataset.id);
            item.classList.add('selected');
        }
    });
    updateDeleteButtonVisibility();
}

function deselectAllMails() {
    // Deselect all emails
    clearSelections();
}

async function deleteSelectedMails() {
    if (selectedEmailIds.size === 0) {
        showNotification('No emails selected for deletion', 'error');
        return;
    }
    
    // Confirm deletion
    if (!confirm(`Are you sure you want to delete ${selectedEmailIds.size} email(s)?`)) {
        return;
    }
    
    try {
        const emailIds = Array.from(selectedEmailIds);
        console.log('Deleting emails:', emailIds);
        
        const response = await fetch('/api/delete-emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            body: JSON.stringify({ email_ids: emailIds }),
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove from UI
            document.querySelectorAll('.email-item').forEach(item => {
                if (selectedEmailIds.has(item.dataset.id) && item.style.display !== 'none') {
                    item.remove();
                }
            });
            
            clearSelections();
            showNotification(`Successfully deleted ${result.deleted_count} email(s)`, 'success');
        } else {
            showNotification(`Failed to delete emails: ${result.error}`, 'error');
        }
        
    } catch (error) {
        console.error('Error deleting emails:', error);
        showNotification('Error deleting emails. Please try again.', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.email-item').forEach(item => {
        // Make sure data-id is present
        if (!item.dataset.id) return;
        // Desktop: click to select/deselect if in selection mode, else open
        item.addEventListener('click', handleEmailItemClick);
        // Mobile: long-press to select
        item.addEventListener('touchstart', handleEmailItemLongPress);
        item.addEventListener('touchend', handleEmailItemTouchEnd);
    });
    // Delete button
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e){
            deleteSelectedMails();
        });
    }
});

// === NOTIFICATION SYSTEM ===

// Initialize notification system
async function initializeNotifications() {
    console.log('Initializing notification system...');
    
    // Check if notifications are supported
    if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return;
    }
    
    // Check if service workers are supported
    if (!('serviceWorker' in navigator)) {
        console.log('This browser does not support service workers');
        return;
    }
    
    try {
        // Register service worker
        serviceWorkerRegistration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker registered successfully:', serviceWorkerRegistration);
        
        // Check current notification permission
        notificationPermission = Notification.permission;
        console.log('Current notification permission:', notificationPermission);
        
        // Get notification status from server
        const status = await getNotificationStatus();
        isNotificationsEnabled = status.enabled;
        
        // Show notification prompt if permission is default
        if (notificationPermission === 'default') {
            showNotificationPrompt();
        } else if (notificationPermission === 'granted' && !status.subscribed) {
            // Subscribe if permission granted but not subscribed
            await subscribeToNotifications();
        }
        
        // Start periodic email checking if notifications are enabled
        if (isNotificationsEnabled && notificationPermission === 'granted') {
            startPeriodicEmailChecking();
        }
        
    } catch (error) {
        console.error('Error initializing notifications:', error);
    }
}

// Show notification permission prompt with mobile optimization
function showNotificationPrompt() {
    const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isPortrait = window.innerHeight > window.innerWidth;
    
    const promptDiv = document.createElement('div');
    promptDiv.id = 'notification-prompt';
    
    // Mobile-optimized styling
    const mobileStyles = isMobileDevice ? `
        position: fixed;
        top: ${isPortrait ? '60px' : '10px'};
        left: 10px;
        right: 10px;
        transform: none;
        background: #2196F3;
        color: white;
        padding: ${isPortrait ? '20px' : '15px'};
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        z-index: 1001;
        font-size: ${isPortrait ? '16px' : '14px'};
        text-align: center;
        backdrop-filter: blur(10px);
        animation: slideInFromTop 0.3s ease-out;
    ` : `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: #2196F3;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1001;
        font-size: 14px;
        max-width: 400px;
        text-align: center;
    `;
    
    promptDiv.style.cssText = mobileStyles;
    
    // Mobile-optimized content
    promptDiv.innerHTML = `
        <div style="margin-bottom: ${isMobileDevice ? '15px' : '10px'};">
            <i class="fa-solid fa-bell" style="margin-right: 8px; font-size: ${isMobileDevice ? '20px' : '16px'};"></i>
            <strong style="font-size: ${isMobileDevice ? '18px' : '14px'};"> Enable Push Notifications?</strong>
        </div>
        <p style="margin: ${isMobileDevice ? '12px' : '8px'} 0; font-size: ${isMobileDevice ? '14px' : '13px'}; line-height: 1.4;">Get instant alerts for new emails on your ${isMobileDevice ? 'mobile device' : 'desktop'}</p>
        <div style="display: flex; gap: ${isMobileDevice ? '15px' : '10px'}; justify-content: center; margin-top: ${isMobileDevice ? '20px' : '15px'};">
            <button onclick="enableNotifications()" style="
                background: white; 
                color: #2196F3; 
                border: none; 
                padding: ${isMobileDevice ? '12px 20px' : '6px 12px'}; 
                border-radius: ${isMobileDevice ? '8px' : '4px'}; 
                cursor: pointer; 
                font-weight: bold;
                font-size: ${isMobileDevice ? '16px' : '14px'};
                min-width: ${isMobileDevice ? '80px' : 'auto'};
                touch-action: manipulation;
            "> Enable</button>
            <button onclick="dismissNotificationPrompt()" style="
                background: transparent; 
                color: white; 
                border: 2px solid white; 
                padding: ${isMobileDevice ? '12px 20px' : '6px 12px'}; 
                border-radius: ${isMobileDevice ? '8px' : '4px'}; 
                cursor: pointer;
                font-size: ${isMobileDevice ? '16px' : '14px'};
                min-width: ${isMobileDevice ? '80px' : 'auto'};
                touch-action: manipulation;
            "> Later</button>
        </div>
    `;
    
    // Add mobile-specific animation styles
    if (isMobileDevice && !document.querySelector('#mobile-notification-styles')) {
        const mobileStyles = document.createElement('style');
        mobileStyles.id = 'mobile-notification-styles';
        mobileStyles.textContent = `
            @keyframes slideInFromTop {
                from {
                    opacity: 0;
                    transform: translateY(-100px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes slideOutToTop {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-100px);
                }
            }
            
            #notification-prompt button {
                transition: all 0.2s ease;
            }
            
            #notification-prompt button:hover {
                transform: scale(1.05);
            }
            
            #notification-prompt button:active {
                transform: scale(0.95);
            }
        `;
        document.head.appendChild(mobileStyles);
    }
    
    document.body.appendChild(promptDiv);
    
    // Auto-dismiss after longer time on mobile for better UX
    const dismissTime = isMobileDevice ? 15000 : 10000;
    setTimeout(() => {
        dismissNotificationPrompt();
    }, dismissTime);
    
    // Add touch event listeners for better mobile interaction
    if (isMobileDevice) {
        promptDiv.addEventListener('touchstart', (e) => {
            e.stopPropagation();
        });
        
        // Dismiss on swipe up
        let touchStartY = 0;
        promptDiv.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        promptDiv.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const swipeDistance = touchStartY - touchEndY;
            
            if (swipeDistance > 50) { // Swipe up to dismiss
                dismissNotificationPrompt();
            }
        });
    }
}

// Enable notifications
async function enableNotifications() {
    try {
        notificationPermission = await Notification.requestPermission();
        console.log('Notification permission result:', notificationPermission);
        
        if (notificationPermission === 'granted') {
            await subscribeToNotifications();
            showNotification('Notifications enabled! You\'ll now receive alerts for new emails.', 'success');
            startPeriodicEmailChecking();
        } else {
            showNotification('Notifications were not enabled. You can enable them later in your browser settings.', 'error');
        }
        
        dismissNotificationPrompt();
        
    } catch (error) {
        console.error('Error enabling notifications:', error);
        showNotification('Error enabling notifications', 'error');
        dismissNotificationPrompt();
    }
}

// Dismiss notification prompt
function dismissNotificationPrompt() {
    const prompt = document.getElementById('notification-prompt');
    if (prompt) {
        prompt.remove();
    }
}

// Subscribe to push notifications
async function subscribeToNotifications() {
    try {
        if (!serviceWorkerRegistration) {
            console.error('Service worker not registered');
            return;
        }
        
        // Get push subscription
        const subscription = await serviceWorkerRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: null // You would use your VAPID public key here
        });
        
        console.log('Push subscription:', subscription);
        
        // Send subscription to server
        const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            body: JSON.stringify({ subscription: subscription.toJSON() }),
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('Subscription saved successfully');
            isNotificationsEnabled = true;
        } else {
            console.error('Failed to save subscription:', result.error);
        }
        
    } catch (error) {
        console.error('Error subscribing to notifications:', error);
    }
}

// Get notification status from server
async function getNotificationStatus() {
    try {
        const response = await fetch('/api/notification-status', {
            credentials: 'same-origin'
        });
        return await response.json();
    } catch (error) {
        console.error('Error getting notification status:', error);
        return { enabled: false, subscribed: false };
    }
}

// Start periodic email checking
function startPeriodicEmailChecking() {
    // Check for new emails every 30 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/api/check-new-emails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCsrfToken()
                },
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            if (result.success && result.new_emails > 0) {
                console.log(`Found ${result.new_emails} new emails`);
                
                // Show browser notification for new emails
                if (notificationPermission === 'granted') {
                    showBrowserNotification(result.emails);
                }
                
                // Optionally refresh the email list
                // performRefresh();
            }
            
        } catch (error) {
            console.error('Error checking for new emails:', error);
        }
    }, 30000); // Check every 30 seconds
}

// Show browser notification for new emails with mobile optimization
function showBrowserNotification(emails) {
    if (emails && emails.length > 0) {
        const firstEmail = emails[0];
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Enhanced mobile-friendly notification content
        const title = emails.length === 1 
            ? ` ${firstEmail.sender}` 
            : ` ${emails.length} new emails`;
        
        const body = emails.length === 1 
            ? firstEmail.subject || '(No subject)'
            : `From: ${firstEmail.sender}${emails.length > 1 ? ` +${emails.length - 1} more` : ''}`;
        
        // Mobile-specific notification options
        const notificationOptions = {
            body: body,
            icon: isMobileDevice ? '/static/logo-192.png' : '/static/logo.png',
            badge: '/static/logo.png',
            tag: 'bharatmail-new-email',
            requireInteraction: isMobileDevice, // More persistent on mobile
            silent: false,
            vibrate: isMobileDevice ? [200, 100, 200] : undefined,
            timestamp: Date.now(),
            data: {
                emailId: firstEmail.id,
                totalEmails: emails.length,
                url: `/read/${firstEmail.id}`
            }
        };
        
        // Add action buttons (not supported on iOS)
        if (!isIOS && 'actions' in Notification.prototype) {
            notificationOptions.actions = [
                {
                    action: 'open',
                    title: isMobileDevice ? ' View' : 'Open Email',
                    icon: '/static/logo.png'
                },
                {
                    action: 'dismiss',
                    title: isMobileDevice ? '' : 'Dismiss',
                    icon: '/static/logo.png'
                }
            ];
        }
        
        // Enhanced notification creation with error handling
        try {
            const notification = new Notification(title, notificationOptions);
            
            // Enhanced click handler for mobile
            notification.onclick = function(event) {
                event.preventDefault();
                
                // Focus window on mobile/desktop
                if (window.focus) {
                    window.focus();
                }
                
                // Navigate to email
                const targetUrl = firstEmail.id ? `/read/${firstEmail.id}` : '/inbox';
                
                if (isMobileDevice) {
                    // On mobile, try to open in same tab
                    window.location.href = targetUrl;
                } else {
                    // On desktop, try to focus existing tab or open new one
                    if (document.hasFocus()) {
                        window.location.href = targetUrl;
                    } else {
                        window.open(targetUrl, '_blank');
                    }
                }
                
                notification.close();
            };
            
            // Handle notification errors
            notification.onerror = function(event) {
                console.error('Notification error:', event);
            };
            
            // Enhanced auto-close timing based on device
            const autoCloseTime = isMobileDevice ? 15000 : 10000; // Longer on mobile
            setTimeout(() => {
                if (notification) {
                    notification.close();
                }
            }, autoCloseTime);
            
            // Log for debugging
            console.log(`Mobile notification shown: ${title}`, {
                isMobile: isMobileDevice,
                isIOS: isIOS,
                emailCount: emails.length
            });
            
        } catch (error) {
            console.error('Failed to create notification:', error);
            
            // Fallback: show in-app notification for mobile browsers with issues
            if (isMobileDevice) {
                showInAppNotification(title, body);
            }
        }
    }
}

// Fallback in-app notification for mobile browsers that don't support native notifications
function showInAppNotification(title, body) {
    const inAppNotification = document.createElement('div');
    inAppNotification.className = 'in-app-notification';
    inAppNotification.style.cssText = `
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        background: #2196F3;
        color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10001;
        font-size: 14px;
        animation: slideInFromTop 0.3s ease-out;
        cursor: pointer;
    `;
    
    inAppNotification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
        <div style="font-size: 13px; opacity: 0.9;">${body}</div>
        <div style="position: absolute; top: 5px; right: 10px; font-size: 18px; cursor: pointer;" onclick="this.parentElement.remove();"></div>
    `;
    
    inAppNotification.addEventListener('click', () => {
        window.location.href = '/inbox';
    });
    
    document.body.appendChild(inAppNotification);
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (inAppNotification.parentNode) {
            inAppNotification.style.animation = 'slideOutToTop 0.3s ease-in';
            setTimeout(() => {
                if (inAppNotification.parentNode) {
                    inAppNotification.remove();
                }
            }, 300);
        }
    }, 8000);
}

// Disable notifications
async function disableNotifications() {
    try {
        const response = await fetch('/api/unsubscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            isNotificationsEnabled = false;
            showNotification('Notifications disabled', 'success');
        }
        
    } catch (error) {
        console.error('Error disabling notifications:', error);
        showNotification('Error disabling notifications', 'error');
    }
}

// Mobile notification settings panel
function showMobileNotificationSettings() {
    const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isPortrait = window.innerHeight > window.innerWidth;
    
    // Close dropdown first
    document.getElementById('profileDropdown').style.display = 'none';
    
    const settingsPanel = document.createElement('div');
    settingsPanel.id = 'notification-settings-panel';
    
    const panelStyles = isMobileDevice ? `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10002;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(5px);
    ` : `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10002;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
    `;
    
    settingsPanel.style.cssText = panelStyles;
    
    const panelContent = document.createElement('div');
    panelContent.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: ${isMobileDevice ? '24px' : '32px'};
        max-width: ${isMobileDevice ? '90vw' : '450px'};
        width: 100%;
        max-height: ${isMobileDevice ? '80vh' : '70vh'};
        overflow-y: auto;
        box-shadow: 0 16px 32px rgba(0,0,0,0.2);
        animation: slideInFromTop 0.3s ease-out;
    `;
    
    // Dark mode support
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        panelContent.style.background = '#2d2e30';
        panelContent.style.color = '#e8eaed';
    }
    
    panelContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: ${isMobileDevice ? '20px' : '24px'}; display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-bell" style="color: #2196F3;"></i>
                Notification Settings
            </h2>
            <button onclick="closeMobileNotificationSettings()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                padding: 5px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">&times;</button>
        </div>
        
        <div style="margin-bottom: 20px; padding: 16px; background: rgba(33,150,243,0.1); border-radius: 8px; border-left: 4px solid #2196F3;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <i class="fa-solid fa-info-circle" style="color: #2196F3;"></i>
                <strong>Current Status</strong>
            </div>
            <div id="notification-status" style="font-size: 14px;">Checking...</div>
        </div>
        
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: ${isMobileDevice ? '16px' : '18px'}; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-mobile-alt" style="color: #4CAF50;"></i>
                ${isMobileDevice ? 'Mobile' : 'Desktop'} Notifications
            </h3>
            <div style="margin-bottom: 16px;">
                <button id="enable-notifications-btn" onclick="enableNotificationsFromSettings()" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: ${isMobileDevice ? '12px 20px' : '10px 16px'};
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: ${isMobileDevice ? '16px' : '14px'};
                    font-weight: bold;
                    margin-right: 10px;
                    touch-action: manipulation;
                ">
                    <i class="fa-solid fa-check"></i> Enable Notifications
                </button>
                <button id="disable-notifications-btn" onclick="disableNotificationsFromSettings()" style="
                    background: #f44336;
                    color: white;
                    border: none;
                    padding: ${isMobileDevice ? '12px 20px' : '10px 16px'};
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: ${isMobileDevice ? '16px' : '14px'};
                    font-weight: bold;
                    touch-action: manipulation;
                    display: none;
                ">
                    <i class="fa-solid fa-times"></i> Disable Notifications
                </button>
            </div>
        </div>
        
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: ${isMobileDevice ? '16px' : '18px'}; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-cogs" style="color: #FF9800;"></i>
                Settings
            </h3>
            <div style="background: rgba(0,0,0,0.05); padding: 16px; border-radius: 8px;">
                <div style="margin-bottom: 12px; font-size: 14px;">
                    <strong>How notifications work:</strong>
                </div>
                <ul style="font-size: 13px; margin: 0; padding-left: 20px; line-height: 1.5;">
                    <li>Real-time alerts for new emails</li>
                    <li>${isMobileDevice ? 'Vibration support on mobile devices' : 'Desktop notifications with sound'}</li>
                    <li>Works even when the app is closed</li>
                    <li>Can be managed in your browser settings</li>
                </ul>
            </div>
        </div>
        
        ${isMobileDevice ? `
        <div style="margin-bottom: 20px; padding: 12px; background: rgba(255,152,0,0.1); border-radius: 6px; border-left: 3px solid #FF9800;">
            <div style="font-size: 13px; color: #F57F17;">
                <i class="fa-solid fa-exclamation-triangle" style="margin-right: 5px;"></i>
                <strong>Mobile Tip:</strong> Add this app to your home screen for the best notification experience!
            </div>
        </div>
        ` : ''}
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="closeMobileNotificationSettings()" style="
                background: #2196F3;
                color: white;
                border: none;
                padding: ${isMobileDevice ? '12px 32px' : '10px 24px'};
                border-radius: 6px;
                cursor: pointer;
                font-size: ${isMobileDevice ? '16px' : '14px'};
                font-weight: bold;
                touch-action: manipulation;
            ">Done</button>
        </div>
    `;
    
    settingsPanel.appendChild(panelContent);
    document.body.appendChild(settingsPanel);
    
    // Update status
    updateNotificationStatusDisplay();
    
    // Close on background click
    settingsPanel.addEventListener('click', (e) => {
        if (e.target === settingsPanel) {
            closeMobileNotificationSettings();
        }
    });
}

function closeMobileNotificationSettings() {
    const panel = document.getElementById('notification-settings-panel');
    if (panel) {
        panel.remove();
    }
}

async function updateNotificationStatusDisplay() {
    const statusDiv = document.getElementById('notification-status');
    const enableBtn = document.getElementById('enable-notifications-btn');
    const disableBtn = document.getElementById('disable-notifications-btn');
    
    if (!statusDiv) return;
    
    const permission = Notification.permission;
    const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    let statusText = '';
    let statusColor = '';
    
    try {
        const status = await getNotificationStatus();
        
        if (permission === 'granted' && status.subscribed && isNotificationsEnabled) {
            statusText = ` Notifications are enabled and working on your ${isMobileDevice ? 'mobile device' : 'desktop'}`;
            statusColor = '#4CAF50';
            enableBtn.style.display = 'none';
            disableBtn.style.display = 'inline-block';
        } else if (permission === 'granted' && !status.subscribed) {
            statusText = ` Permission granted but not subscribed. Click 'Enable Notifications' to fix this.`;
            statusColor = '#FF9800';
            enableBtn.style.display = 'inline-block';
            disableBtn.style.display = 'none';
        } else if (permission === 'denied') {
            statusText = ` Notifications are blocked. Please enable them in your browser settings.`;
            statusColor = '#f44336';
            enableBtn.style.display = 'none';
            disableBtn.style.display = 'none';
        } else {
            statusText = ` Notifications are not yet enabled. Click 'Enable Notifications' to get started.`;
            statusColor = '#666';
            enableBtn.style.display = 'inline-block';
            disableBtn.style.display = 'none';
        }
    } catch (error) {
        statusText = ' Unable to check notification status';
        statusColor = '#f44336';
    }
    
    statusDiv.innerHTML = statusText;
    statusDiv.style.color = statusColor;
}

async function enableNotificationsFromSettings() {
    await enableNotifications();
    setTimeout(updateNotificationStatusDisplay, 1000);
}

async function disableNotificationsFromSettings() {
    await disableNotifications();
    setTimeout(updateNotificationStatusDisplay, 1000);
}

// Initialize notifications when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize notification system after a short delay
    setTimeout(() => {
        initializeNotifications();
    }, 1000);
});

// Step 5: Scroll-to-refresh on mobile
let lastScrollTop = 0;
const emailList = document.querySelector('.email-list');
if(emailList) {
    emailList.addEventListener('scroll', function() {
        if(emailList.scrollTop === 0 && lastScrollTop > 0 && window.innerWidth <= 768) {
            refreshMails();
        }
        lastScrollTop = emailList.scrollTop;
    });
}
</script>

<!-- Floating Delete Button -->
<button id="deleteSelectedBtn" style="
    display: none;
    position: fixed;
    bottom: 90px;
    right: 20px;
    background-color: #e53935;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    font-weight: bold;
    cursor: pointer;
    z-index: 600;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-size: 16px;
"
>
    <i class="fa-solid fa-trash"></i> Delete
</button>

<!-- Floating Compose Button -->
<button class="compose-float-btn" onclick="openCompose()">
    <i class="fa-solid fa-pencil"></i> Compose
</button>

</body>
</html>
<style>
/* Account dropdown styling */
.active-account {
    background: linear-gradient(135deg, rgba(26,115,232,0.1), rgba(26,115,232,0.05));
    border: 2px solid rgba(26,115,232,0.3);
    border-radius: 8px;
    margin-bottom: 8px;
}

.active-indicator {
    color: #1a73e8;
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.accounts-section-header {
    padding: 8px 15px;
    font-weight: 600;
    font-size: 12px;
    color: #5f6368;
    border-bottom: 1px solid rgba(128,128,128,0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-item {
    transition: all 0.2s ease;
    border-radius: 6px;
    margin: 2px 6px;
}

.account-item:hover {
    background-color: rgba(26,115,232,0.08) !important;
    transform: translateX(2px);
}

.logout-btn {
    color: #e53935 !important;
    font-size: 16px;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.logout-btn:hover {
    background-color: rgba(229,57,53,0.1);
    transform: scale(1.1);
}

@media (prefers-color-scheme: dark) {
    .active-account {
        background: linear-gradient(135deg, rgba(26,115,232,0.2), rgba(26,115,232,0.1));
        border-color: rgba(26,115,232,0.4);
    }
    
    .accounts-section-header {
        color: #9aa0a6;
    }
    
    .account-item:hover {
        background-color: rgba(26,115,232,0.15) !important;
    }
}

/* Highlight selected emails */
.email-item.selected {
    background-color: #e3f0fd !important;
    /* fallback for light */
    border-left: 4px solid var(--accent);
}
@media (prefers-color-scheme: dark) {
    .email-item.selected {
        background-color: #174ea6 !important;
        color: #fff;
        border-left: 4px solid var(--accent);
    }
}
</style>